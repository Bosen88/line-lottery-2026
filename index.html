<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 é¦¬ä¸Šæœ‰éŒ¢æ–°æ˜¥æŠ½æŠ½æ¨‚</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary-red: #d93025; --primary-gold: #ffd700; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: var(--primary-red); color: #333; min-height: 100vh; display: flex; justify-content: center; align-items: center; text-align: center; margin: 0;}
        .container { background: #fff; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; border: 5px solid var(--primary-gold); }
        .horse-deco { font-size: 4rem; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .card { aspect-ratio: 1; cursor: pointer; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 10px; padding: 5px; flex-direction: column; }
        .card-front { background: linear-gradient(135deg, #ffd700, #ffb300); color: #d93025; font-size: 2rem; border: 2px solid #fff; }
        .card-back { background: #fff; transform: rotateY(180deg); border: 2px solid var(--primary-gold); }
        .prize-img { max-width: 80%; max-height: 50px; object-fit: contain; margin-bottom: 5px; }
        .message-box { margin-top: 20px; padding: 15px; background: #fff8e1; border-radius: 15px; border: 2px dashed var(--primary-gold); display: none; }
        .btn-start { background: linear-gradient(180deg, #ff5252 0%, #d50000 100%); color: white; padding: 12px 30px; border-radius: 50px; border: none; font-size: 1.2rem; cursor: pointer; width: 80%; margin-top: 10px; }
        input[type="text"] { width: 80%; padding: 12px; font-size: 1.1rem; border: 3px solid #eee; margin-bottom: 10px; text-align: center; border-radius: 50px; }
        .btn-share { display: inline-block; margin-top: 10px; padding: 8px 20px; background-color: #06c755; color: white; text-decoration: none; border-radius: 5px; font-size: 0.9rem; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="horse-deco">ğŸ</div>
    <h1>2026 é¦¬ä¸Šæœ‰éŒ¢</h1>
    <p>LINE è³¼ç‰©ç¾¤å‹å°ˆå±¬æ´»å‹•</p>
    <div id="login-section">
        <input type="text" id="nickname" placeholder="è«‹è¼¸å…¥ LINE æš±ç¨±">
        <br><button class="btn-start" onclick="checkUser()">ğŸ‘‰ é¦¬ä¸Šé–‹æŠ½</button>
    </div>
    <div id="game-section" style="display:none;">
        <p style="font-weight:bold; color:#d93025;">âœ¨ è«‹é»æ“Šä¸€å¼µç™¼è²¡ç‰Œ âœ¨</p>
        <div class="grid-container" id="grid"></div>
        <div class="message-box" id="result-msg"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ğŸ”´ è«‹åœ¨ä¸‹é¢è²¼ä¸Šæ‚¨çš„ Firebase Config ğŸ”´ğŸ”´
    const firebaseConfig = {
        apiKey: "AIzaSyD_VwNV9-pcv91aFfcWQWCJ0NJtSIKi42o",
        authDomain: "lottery-2026.firebaseapp.com",
        projectId: "lottery-2026",
        storageBucket: "lottery-2026.firebasestorage.app",
        messagingSenderId: "451105292594",
        appId: "1:451105292594:web:ca1e74f3e88daae298972b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentNickname = '';
    let displayPrizePool = [];

    window.checkUser = async function() {
        const input = document.getElementById('nickname').value.trim();
        if (!input) return alert('è«‹è¼¸å…¥æš±ç¨±ï¼');
        currentNickname = input;
        const btn = document.querySelector('.btn-start');
        btn.innerHTML = 'æª¢æŸ¥è³‡æ ¼ä¸­...'; btn.disabled = true;

        try {
            // æŠ“å–é¡¯ç¤ºç”¨çš„å¡«å……çé …
            const configSnap = await getDoc(doc(db, "settings", "game_config"));
            if (configSnap.exists()) { displayPrizePool = configSnap.data().prizes; }
            else { displayPrizePool = [{name: 'å¤§å‰å¤§åˆ©'}, {name: 'æ­å–œç™¼è²¡'}]; }

            // æª¢æŸ¥æ˜¯å¦æŠ½é
            const userRef = doc(db, "participants", currentNickname);
            const userSnap = await getDoc(userRef);
            renderGrid();

            if (userSnap.exists()) {
                const data = userSnap.data();
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('game-section').style.display = 'block';
                let dateStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString('zh-TW') : "æ™‚é–“è¨˜éŒ„ä¸­...";
                setTimeout(() => {
                    alert(`æ‚¨å·²æŠ½éå›‰ï¼\nçé …ï¼š${data.prize.name}`);
                    revealAll(data.prize);
                    showResult(data.prize, dateStr);
                }, 500);
            } else {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('game-section').style.display = 'block';
            }
        } catch (e) {
            console.error(e); alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡è©¦'); location.reload();
        }
    }

    let isProcessing = false;
    window.doDraw = async function(index) {
        if (isProcessing) return;
        const card = document.getElementById(`card-${index}`);
        if(card.classList.contains('flipped')) return;
        isProcessing = true;
        card.style.animation = "shake 0.5s"; // æ–æ™ƒç‰¹æ•ˆ

        const configRef = doc(db, "settings", "game_config");
        const userRef = doc(db, "participants", currentNickname);

        try {
            const finalResult = await runTransaction(db, async (transaction) => {
                const configDoc = await transaction.get(configRef);
                const userDoc = await transaction.get(userRef);
                if (userDoc.exists()) throw "Played";
                if (!configDoc.exists()) throw "NoConfig";

                const prizes = configDoc.data().prizes;
                let validIndices = [];
                // æ ¹æ“šå‰©é¤˜æ•¸é‡å»ºç«‹æŠ½çæ± 
                prizes.forEach((p, idx) => {
                    const count = (p.count !== undefined) ? p.count : 0;
                    for(let i=0; i < count; i++) validIndices.push(idx);
                });

                if (validIndices.length === 0) throw "SoldOut";

                const rand = Math.floor(Math.random() * validIndices.length);
                const winnerIndex = validIndices[rand];
                const winningPrize = prizes[winnerIndex];

                // æ‰£åº«å­˜ä¸¦å¯«å…¥
                prizes[winnerIndex].count--;
                transaction.update(configRef, { prizes: prizes });
                transaction.set(userRef, { prize: winningPrize, timestamp: serverTimestamp() });
                return winningPrize;
            });

            const now = new Date();
            card.style.animation = "";
            revealOne(index, finalResult);
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            showResult(finalResult, now.toLocaleString('zh-TW'));
        } catch (e) {
            isProcessing = false; card.style.animation = "";
            if (e === "Played") alert("æ‚¨å·²ç¶“ç©éå›‰ï¼");
            else if (e === "SoldOut") alert("æ‰€æœ‰çé …éƒ½å·²æŠ½å®Œå›‰ï¼");
            else alert("ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼");
        }
    }

    function renderGrid() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        for(let i=0; i<9; i++) {
            let card = document.createElement('div'); card.className = 'card'; card.id = `card-${i}`;
            card.onclick = () => doDraw(i);
            card.innerHTML = `<div class="card-face card-front">ç¦</div><div class="card-face card-back">...</div>`;
            grid.appendChild(card);
        }
    }

    function revealOne(index, prizeData) {
        const card = document.getElementById(`card-${index}`);
        const imgHtml = prizeData.img ? `<img src="${prizeData.img}" class="prize-img">` : '';
        card.querySelector('.card-back').innerHTML = `${imgHtml}<div style="font-weight:900;">${prizeData.name}</div>`;
        card.classList.add('flipped');
        setTimeout(() => {
            for(let i=0; i<9; i++) {
                if(i !== index) {
                    const c = document.getElementById(`card-${i}`);
                    const randomFill = displayPrizePool[Math.floor(Math.random()*displayPrizePool.length)];
                    const fillImg = randomFill.img ? `<img src="${randomFill.img}" class="prize-img">` : '';
                    c.querySelector('.card-back').innerHTML = `${fillImg}<span style="font-size:0.8rem; color:#aaa;">${randomFill.name}</span>`;
                    c.classList.add('flipped'); c.style.opacity = '0.5'; c.onclick = null;
                }
            }
        }, 600);
    }
    
    function revealAll(prizeData) {
        const card = document.getElementById(`card-4`);
        const imgHtml = prizeData.img ? `<img src="${prizeData.img}" class="prize-img">` : '';
        card.querySelector('.card-back').innerHTML = `${imgHtml}<div style="font-weight:900;">${prizeData.name}</div>`;
        card.classList.add('flipped');
    }

    function showResult(prizeData, timeStr) {
        const msg = document.getElementById('result-msg');
        const shareText = `æˆ‘åœ¨ã€Œé¦¬ä¸Šæœ‰éŒ¢æŠ½æŠ½æ¨‚ã€æŠ½ä¸­äº†ã€${prizeData.name}ã€‘ï¼`;
        const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(shareText)}`;
        msg.innerHTML = `<div>æ­å–œ <strong>${currentNickname}</strong> ç²å¾—ï¼š</div><h2 style="margin:10px 0; font-size:1.6rem;">${prizeData.name}</h2>${prizeData.img ? `<img src="${prizeData.img}" style="max-width:100px; border-radius:10px;">` : ''}<div style="font-size:0.8rem; color:#666; margin-top:10px; border-top:1px solid #ccc;">ğŸ“… ${timeStr}</div><a href="${lineUrl}" target="_blank" class="btn-share">ğŸ’¬ ç‚«è€€çµ¦æœ‹å‹çœ‹</a><div style="margin-top:10px; color:red; font-size:0.8rem;">ğŸ“¸ è«‹æˆªåœ–æ­¤ç•«é¢é ˜ç</div>`;
        msg.style.display = 'block';
    }
</script>
</body>
</html>
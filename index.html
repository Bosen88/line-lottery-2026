<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 é¦¬ä¸Šæœ‰éŒ¢æ–°æ˜¥æŠ½æŠ½æ¨‚</title>
    <style>
        /* CSS æ¨£å¼ç¶­æŒä¸è®Šï¼Œä¿æŒå–œæ°£ */
        :root { --primary-red: #d93025; --primary-gold: #ffd700; }
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: var(--primary-red);
            background-image: radial-gradient(circle, #e64c4c 10%, transparent 10%);
            background-size: 20px 20px;
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }
        .container {
            background: #fff;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            border: 4px solid var(--primary-gold);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .horse-deco { font-size: 3rem; margin-bottom: -10px; }
        h1 { color: var(--primary-red); margin-bottom: 5px; font-weight: 800; font-size: 1.5rem; }
        .sub-title { color: #666; font-size: 0.9rem; margin-bottom: 20px; }
        input[type="text"] { width: 80%; padding: 12px; font-size: 1rem; border: 2px solid #ddd; margin-bottom: 15px; text-align: center; border-radius: 8px;}
        .btn-start { background: var(--primary-red); color: var(--primary-gold); border: none; padding: 12px 30px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .card { background-color: var(--primary-gold); aspect-ratio: 1; border-radius: 8px; cursor: pointer; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: bold; padding: 5px; box-sizing: border-box; }
        .card-front { background: linear-gradient(135deg, #ffeb3b 0%, #fbc02d 100%); color: #d93025; font-size: 2rem; border: 2px solid #fff; }
        .card-back { background: #fff; color: #d93025; transform: rotateY(180deg); border: 2px solid var(--primary-gold); font-size: 0.9rem; }
        .message-box { margin-top: 20px; padding: 10px; background: #ffebee; color: #c62828; border-radius: 8px; font-size: 0.9rem; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="horse-deco">ğŸ</div>
    <h1>2026 é¦¬ä¸Šæœ‰éŒ¢<br>æ–°æ˜¥æŠ½æŠ½æ¨‚</h1>
    <p class="sub-title">LINE è³¼ç‰©ç¾¤å‹å°ˆå±¬æ´»å‹•</p>

    <div id="login-section">
        <p>è«‹å…ˆè¼¸å…¥æ‚¨çš„ LINE æš±ç¨±</p>
        <input type="text" id="nickname" placeholder="ä¾‹å¦‚: ç‹å°æ˜">
        <br>
        <button class="btn-start" onclick="checkUser()">é–‹å§‹æŠ½ç</button>
    </div>

    <div id="game-section" style="display:none;">
        <p>è«‹é»æ“Šä»»æ„ä¸€å¼µç‰Œï¼</p>
        <div class="grid-container" id="grid"></div>
        <div class="message-box" id="result-msg"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ğŸ”´ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨å¾ Firebase Console è¤‡è£½çš„è¨­å®š ğŸ”´ğŸ”´
	const firebaseConfig = {
 	 apiKey: "AIzaSyD_VwNV9-pcv91aFfcWQWCJ0NJtSIKi42o",
 	 authDomain: "lottery-2026.firebaseapp.com",
 	 projectId: "lottery-2026",
	 storageBucket: "lottery-2026.firebasestorage.app",
	
 	 appId: "1:451105292594:web:ca1e74f3e88daae298972b"
	};

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentNickname = '';
    let isProcessing = false;

    window.checkUser = async function() {
        const input = document.getElementById('nickname').value.trim();
        if (!input) return alert('è«‹è¼¸å…¥æš±ç¨±');
        
        currentNickname = input;
        document.getElementById('login-section').innerHTML = '<p>è®€å–è³‡æ–™ä¸­...</p>';

        try {
            // æª¢æŸ¥æ˜¯å¦æŠ½é (ç›´æ¥ç”¨æš±ç¨±ç•¶ IDï¼Œä¿è­‰å”¯ä¸€)
            const docRef = doc(db, "participants", currentNickname);
            const docSnap = await getDoc(docRef);

            renderGrid(); // å…ˆç•«æ ¼å­

            if (docSnap.exists()) {
                // å·²æŠ½é -> é¡¯ç¤ºçµæœ
                const data = docSnap.data();
                alert(`æ‚¨å·²ç¶“åƒåŠ éå›‰ï¼çµæœæ˜¯ï¼š${data.prize}`);
                revealAll(data.prize);
                showResult(data.prize, true);
            } else {
                // æ²’æŠ½é -> é€²å…¥éŠæˆ²æ¨¡å¼
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('game-section').style.display = 'block';
            }
        } catch (e) {
            console.error(e);
            alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            location.reload();
        }
    }

    window.doDraw = async function(index) {
        if (isProcessing) return;
        isProcessing = true;

        // å®šç¾©çé …èˆ‡æ©Ÿç‡ (å‰ç«¯é‚è¼¯)
        const prizes = [
            'ç¨å®¶ä»£ç†å•†å“ 9æŠ˜å·', 'ç¨å®¶ä»£ç†å•†å“ 9æŠ˜å·', 'ç¨å®¶ä»£ç†å•†å“ 95æŠ˜å·',
            'é¦¬å¹´è¡Œå¤§é‹', 'æ­å–œç™¼è²¡', 'æ–°æ˜¥å¤§å‰', 'é¦¬ä¸Šæœ‰éŒ¢', 'å¿ƒæƒ³äº‹æˆ', 'è¬äº‹å¦‚æ„'
        ];
        // éš¨æ©ŸæŠ½ä¸€å€‹
        const result = prizes[Math.floor(Math.random() * prizes.length)];

        try {
            // å¯«å…¥ Firebase (ä½¿ç”¨ setDoc å¯«å…¥ï¼Œå¦‚æœæš±ç¨±å·²å­˜åœ¨æœƒå¤±æ•—æˆ–è¦†è“‹ï¼Œ
            // ä½†å› ç‚ºå‰é¢ checkUser æª¢æŸ¥éäº†ï¼Œä¸”æˆ‘å€‘ç›¸ä¿¡ User åªæ˜¯ç©éŠæˆ²)
            // åš´è¬¹ä¸€é»å¯ä»¥ç”¨ Transactionï¼Œä½†é€™è£¡æ±‚ç°¡å–®
            await setDoc(doc(db, "participants", currentNickname), {
                prize: result,
                timestamp: serverTimestamp()
            });

            // æˆåŠŸå¯«å…¥å¾Œï¼Œç¿»ç‰Œ
            revealOne(index, result);
            showResult(result, false);

        } catch (e) {
            alert('æŠ½çç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
            isProcessing = false;
        }
    }

    function renderGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        for(let i=0; i<9; i++) {
            let card = document.createElement('div');
            card.className = 'card';
            card.id = `card-${i}`;
            card.onclick = () => doDraw(i);
            card.innerHTML = `
                <div class="card-face card-front">ç¦</div>
                <div class="card-face card-back">?</div>
            `;
            grid.appendChild(card);
        }
    }

    function revealOne(index, prize) {
        const card = document.getElementById(`card-${index}`);
        card.querySelector('.card-back').innerText = prize;
        card.classList.add('flipped');
        
        // ç¿»é–‹å…¶ä»–çš„ (éš¨æ©Ÿå¡«å……)
        setTimeout(() => {
            const fillers = ['æ­å–œç™¼è²¡', 'éŠ˜è¬æƒ é¡§', 'å†æ¥å†å²', 'é¦¬å¹´å¿«æ¨‚'];
            for(let i=0; i<9; i++) {
                if(i !== index) {
                    const c = document.getElementById(`card-${i}`);
                    c.querySelector('.card-back').innerText = fillers[Math.floor(Math.random()*fillers.length)];
                    c.classList.add('flipped');
                    c.style.opacity = '0.5';
                }
            }
        }, 800);
    }

    function revealAll(prize) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('game-section').style.display = 'block';
        // é€™è£¡ç°¡å–®è™•ç†ï¼šç›´æ¥å…¨éƒ¨ç¿»é–‹ï¼Œä¸­é–“é‚£æ ¼é¡¯ç¤ºçé …
        setTimeout(() => {
            const card = document.getElementById(`card-4`); // ä¸­é–“é‚£æ ¼
            card.querySelector('.card-back').innerText = prize;
            card.classList.add('flipped');
        }, 100);
    }

    function showResult(prize, isReplay) {
        const msg = document.getElementById('result-msg');
        msg.innerHTML = `æ­å–œ <strong>${currentNickname}</strong> æŠ½ä¸­ï¼š<br><h2>${prize}</h2><br><small>ğŸ“¸ è«‹æˆªåœ–å›å‚³</small>`;
        msg.style.display = 'block';
    }
</script>

</body>
</html>